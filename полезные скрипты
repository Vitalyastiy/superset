–ü–æ–ª–µ–∑–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
-- –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ß–ê–†–¢–û–í
WITH chart_loads AS (
  SELECT
    SUBSTRING(json FROM '"slice_id": ?([0-9]+)')::INT as chart_id,
    SUBSTRING(json FROM '"source_id": ?([0-9]+)')::INT as dashboard_id,
    
    -- –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
    CASE 
      WHEN json LIKE '%duration%' THEN 
        SUBSTRING(json FROM '"duration": ?([0-9.]+)')::DECIMAL
      WHEN json LIKE '%load_time%' THEN 
        SUBSTRING(json FROM '"load_time": ?([0-9.]+)')::DECIMAL
      WHEN json LIKE '%response_time%' THEN 
        SUBSTRING(json FROM '"response_time": ?([0-9.]+)')::DECIMAL
      ELSE NULL
    END as load_time_ms,
    
    SUBSTRING(json FROM '"impression_id": ?"([^"]+)"') as session_id,
    dttm
    
  FROM logs
  WHERE (json LIKE '%load_chart%' OR json LIKE '%chart_load%' OR json LIKE '%slice_id%')
    AND json NOT LIKE '%error%'  -- –ò—Å–∫–ª—é—á–∞–µ–º –æ—à–∏–±–∫–∏
    AND dttm >= CURRENT_DATE - INTERVAL '7 days'
    AND SUBSTRING(json FROM '"slice_id": ?([0-9]+)')::INT IS NOT NULL
)

SELECT
  '‚è±Ô∏è SLOW CHART PERFORMANCE' as report_type,
  
  cl.chart_id,
  s.slice_name as chart_name,
  s.viz_type as chart_type,
  d.dashboard_title as parent_dashboard,
  
  -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫
  COUNT(*) as load_count,
  COUNT(DISTINCT cl.session_id) as affected_users,
  
  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
  ROUND(AVG(cl.load_time_ms / 1000.0), 2) as avg_load_time_sec,
  ROUND(MAX(cl.load_time_ms), 0) as max_load_ms,
  ROUND(MIN(cl.load_time_ms), 0) as min_load_ms,
  
  -- –ü—Ä–æ—Ü–µ–Ω—Ç –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ (< 3 —Å–µ–∫)
  ROUND(
    COUNT(CASE WHEN cl.load_time_ms < 3000 THEN 1 END) * 100.0 / COUNT(*), 
    1
  ) as fast_loads_percent,
  
  -- –ü—Ä–æ—Ü–µ–Ω—Ç –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ (> 10 —Å–µ–∫)
  ROUND(
    COUNT(CASE WHEN cl.load_time_ms > 10000 THEN 1 END) * 100.0 / COUNT(*), 
    1
  ) as slow_loads_percent,
  
  -- –°—Ç–∞—Ç—É—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  CASE
    WHEN AVG(cl.load_time_ms) > 15000 THEN 'üî¥ –ö–†–ò–¢–ò–ß–ù–û'
    WHEN AVG(cl.load_time_ms) > 8000 THEN 'üü† –ú–ï–î–õ–ï–ù–ù–û'
    WHEN AVG(cl.load_time_ms) > 4000 THEN 'üü° –ù–û–†–ú–ê'
    ELSE 'üü¢ –ë–´–°–¢–†–û'
  END as performance_status,
  
  -- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  CASE
    WHEN AVG(cl.load_time_ms) > 15000 AND s.viz_type = 'table' THEN 'üìä –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—É'
    WHEN AVG(cl.load_time_ms) > 15000 THEN '‚ö° –ö—Ä–∏—Ç–∏—á–Ω–æ: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å'
    WHEN AVG(cl.load_time_ms) > 8000 AND s.viz_type IN ('line', 'bar') THEN 'üìà –£–º–µ–Ω—å—à–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö'
    WHEN AVG(cl.load_time_ms) > 8000 THEN 'üîß –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å'
    WHEN COUNT(CASE WHEN cl.load_time_ms > 10000 THEN 1 END) > COUNT(*) * 0.3 THEN 'üìä –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'
    ELSE '‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ'
  END as recommendation,
  
  -- –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞
  MAX(cl.dttm) as last_load

FROM chart_loads cl
LEFT JOIN slices s ON s.id = cl.chart_id
LEFT JOIN dashboards d ON d.id = cl.dashboard_id

WHERE cl.load_time_ms IS NOT NULL
  AND cl.load_time_ms > 0  -- –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

GROUP BY 
  cl.chart_id,
  s.slice_name,
  s.viz_type,
  d.dashboard_title

HAVING ROUND(AVG(cl.load_time_ms / 1000.0), 2) > 4 -- COUNT(*) >= 5  -- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Ä—Ç—ã —Å 5+ –∑–∞–≥—Ä—É–∑–∫–∞–º–∏

ORDER BY 
  AVG(cl.load_time_ms) DESC,  -- –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ
  COUNT(*) DESC;





----------------





